<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2023-10-31T10:49:57+00:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">James Hope</title><subtitle></subtitle><author><name>James Hope</name></author><entry><title type="html">Graph-Driven, LLM-Assisted Virtual Assistant Architecture</title><link href="http://localhost:4000/genai/ai/llms/graph-driven-llm-assistant-virtual-assistant/" rel="alternate" type="text/html" title="Graph-Driven, LLM-Assisted Virtual Assistant Architecture" /><published>2023-10-02T20:46:34+01:00</published><updated>2023-10-02T20:46:34+01:00</updated><id>http://localhost:4000/genai/ai/llms/graph-driven-llm-assistant-virtual-assistant</id><content type="html" xml:base="http://localhost:4000/genai/ai/llms/graph-driven-llm-assistant-virtual-assistant/"><![CDATA[<p>View the post here: <a href="https://jamesdhope.medium.com/graph-driven-llm-assisted-virtual-assistant-architecture-c1e4857a7040">https://jamesdhope.medium.com/graph-driven-llm-assisted-virtual-assistant-architecture-c1e4857a7040</a>.</p>]]></content><author><name>James Hope</name></author><category term="GenAI" /><category term="AI" /><category term="LLMs" /><category term="data science" /><category term="GenAI" /><category term="LLMs" /><summary type="html"><![CDATA[View the post here: https://jamesdhope.medium.com/graph-driven-llm-assisted-virtual-assistant-architecture-c1e4857a7040.]]></summary></entry><entry><title type="html">Gas System of the Future, Digital Twin</title><link href="http://localhost:4000/ibm/e&u/gas-system-of-the-future/" rel="alternate" type="text/html" title="Gas System of the Future, Digital Twin" /><published>2022-12-02T19:46:34+00:00</published><updated>2022-12-02T19:46:34+00:00</updated><id>http://localhost:4000/ibm/e&amp;u/gas-system-of-the-future</id><content type="html" xml:base="http://localhost:4000/ibm/e&amp;u/gas-system-of-the-future/"><![CDATA[<p>This article was published on Medium. Please click <a target="_new" href="https://jamesdhope.medium.com/gas-system-of-the-future-digital-twin-9e1622024462">here</a> to access the article.</p>]]></content><author><name>James Hope</name></author><category term="IBM" /><category term="E&amp;U" /><category term="E&amp;U" /><category term="Energy" /><category term="IBM" /><summary type="html"><![CDATA[This article was published on Medium. Please click here to access the article.]]></summary></entry><entry><title type="html">Injecting Config as Environment Variables from Hasicorp’s Consul &amp;amp; Vault</title><link href="http://localhost:4000/kubernetes,/neo4j,/solution/architecture,/hasicorp,/vault,/consul/vault-template/" rel="alternate" type="text/html" title="Injecting Config as Environment Variables from Hasicorp’s Consul &amp;amp; Vault" /><published>2021-11-10T19:46:34+00:00</published><updated>2021-11-10T19:46:34+00:00</updated><id>http://localhost:4000/kubernetes,/neo4j,/solution/architecture,/hasicorp,/vault,/consul/vault-template</id><content type="html" xml:base="http://localhost:4000/kubernetes,/neo4j,/solution/architecture,/hasicorp,/vault,/consul/vault-template/"><![CDATA[<p>Continuing with the theme of Kubernetes, I have recently built out a solution to inject environment variables into containerised applications from Hasicorp Consult and Vault Key Value (KV) engine, which might be considered as a first step in realising Hashicorp’s Service Mesh. Installing both Consul and Vault via helm with the KV Engine is fairly straightforward. Supplying these KV’s as environment variables to the containerised applications in Kubernetes, however, requires a bit more thought. Two different approaches are required to lift in values from Consul and Vault which makes things even more interesting. The approach I took was to write the KV’s to file before they are exposed as ENVs in the container, which is less than ideal. As a side note, it might be cleaner and simpler to manage config at the application layer by calling Consul and Vault’s HTTP API. That is another approach which I’m not going to talk about here.</p>

<p>For the purposes of this explanation I’m supplying environment variables to an application called Hasura graphQL API. Config is held in Consul and Vault in their respective KV Engines.</p>

<p><img src="/assets/images/containers.jpg" alt="GitHub Logo" />
Source: https://www.pexels.com/</p>

<h2 id="fetching-kvs-from-consul-using-envconsul">Fetching KV’s from Consul using envconsul</h2>

<p>Hasicorp provide a application called envconsul to fetch KV’s from consul. I used that to write the KV’s to a mounted volume ready to run as a bash script to expose them in the main application container. Note the use of the sed command to substitue the export statement. This achieves a file with lines that read <code class="language-plaintext highlighter-rouge">export key value</code> which can be run as a bash script to expose those KV’s as ENVs in the main application container.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>initContainers:
- name: envconsul
        image: hashicorp/envconsul:alpine
        
        command: ['sh','-c','envconsul -consul-addr=consul-consul-server.consul.svc.cluster.local:8500 -pristine -prefix staging/hasura env | sed "s/.*/export &amp;/" &gt; /consul/config/staging-hasura']
- mountPath: /consul/config/
        name: consul
</code></pre></div></div>

<h2 id="fetching-kvs-from-vault-using-vault-annotations">Fetching KV’s from Vault using Vault Annotations</h2>

<p>To fetch secrets from Vault I used the annotations shown in the snippet below which are patched to the deployment for Hasura. Note the <code class="language-plaintext highlighter-rouge">vault.hashicorp.com/agent-inject: "true"</code> label in the code snippet below which activates the Envoy sidecar although there is more going on here including an initContainer for Vault to initiate the mTLS mechanism so I’d recommend reading the docs. See https://www.vaultproject.io/docs/platform/k8s/injector/annotations.</p>

<p>The label I wanted to give special mention to is <code class="language-plaintext highlighter-rouge">vault.hashicorp.com/agent-inject-template-staging-hasura:</code> which utilises a GO template. The template shown in the code snippet below writes the key value pairs in vault (prefixed with the word export) to file, ready to run as a bash script. This writes the same file output as the command for envconsul above.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>`kubectl patch deployment hasura --patch "$(cat staging-vault-patch.yaml)" -n hasura`
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spec:
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-status: "update"
        vault.hashicorp.com/agent-inject-secret-staging-hasura: "staging/hasura"
        vault.hashicorp.com/agent-inject-template-staging-hasura: |
          
              export =
            
        vault.hashicorp.com/role: "vault-hasura-service-account"
        vault.hashicorp.com/log-level: "debug"
</code></pre></div></div>

<p>Note that Vault also requires you to set up a Kubernetes Service Account <code class="language-plaintext highlighter-rouge">serviceAccountName: vault-service</code>. Refer to the Hashicorp docs for more information on this.</p>

<h2 id="exposing-the-kvs-into-the-main-application-container">Exposing the KV’s into the main application container</h2>

<p>Hasura deployment spec can be updated with a command statement: <code class="language-plaintext highlighter-rouge">command: ['sh', '-c', '. vault/secrets/staging-hasura &amp;&amp; . consul/config/staging-hasura &amp;&amp; graphql-engine serve']</code>. Using sh with the dot command to execute the bash scripts exposing the KV’s as environment variables in the main application container, and then launching into the application itself. If you take this approach, be aware that the Kubernetes command statement will take precedence over any entrypoint command used in the dockerfile. If you are utilising a third party image that utilises an entrypoint statement you may need to create a custom dockerfile to make this approach work.</p>]]></content><author><name>James Hope</name></author><category term="Kubernetes," /><category term="Neo4j," /><category term="Solution" /><category term="Architecture," /><category term="Hasicorp," /><category term="Vault," /><category term="Consul" /><summary type="html"><![CDATA[Continuing with the theme of Kubernetes, I have recently built out a solution to inject environment variables into containerised applications from Hasicorp Consult and Vault Key Value (KV) engine, which might be considered as a first step in realising Hashicorp’s Service Mesh. Installing both Consul and Vault via helm with the KV Engine is fairly straightforward. Supplying these KV’s as environment variables to the containerised applications in Kubernetes, however, requires a bit more thought. Two different approaches are required to lift in values from Consul and Vault which makes things even more interesting. The approach I took was to write the KV’s to file before they are exposed as ENVs in the container, which is less than ideal. As a side note, it might be cleaner and simpler to manage config at the application layer by calling Consul and Vault’s HTTP API. That is another approach which I’m not going to talk about here.]]></summary></entry><entry><title type="html">Backup and Restore Neo4j in a Casual Cluster</title><link href="http://localhost:4000/kubernetes,/neo4j,/solution/architecture/neo4j-backup-restore/" rel="alternate" type="text/html" title="Backup and Restore Neo4j in a Casual Cluster" /><published>2021-11-10T19:46:34+00:00</published><updated>2021-11-10T19:46:34+00:00</updated><id>http://localhost:4000/kubernetes,/neo4j,/solution/architecture/neo4j-backup-restore</id><content type="html" xml:base="http://localhost:4000/kubernetes,/neo4j,/solution/architecture/neo4j-backup-restore/"><![CDATA[<p>If you’re managing a data engine inside a kubernetes cluster then implementing a backup and restore process can be challenging. A few months ago I developed a solution architecture deploying Neo4j into Kubernetes as a casual cluster. There’s a Medium post by Neo4j’s David Allen to explain what that configuration looks like <a target="_new" href="https://medium.com/neo4j/querying-neo4j-clusters-7d6fde75b5b4">here</a>. Unfortunately Neo4j doesn’t officially support a casual cluster deployment, but there are community maintained helm charts endorsed by Neo4j that make this achieveable. For this solution I needed a simple backup and restore (nothing more) which is what I wanted to focus on here.</p>

<p><img src="/assets/images/containers.jpg" alt="GitHub Logo" />
Source: https://www.pexels.com/</p>

<h2 id="technology-native-versus-snapshots">Technology-native versus Snapshots</h2>

<p>The approach of snapshotting persistent volumes for a distributed data engine as a means to backup data can and does lead to situations where a subsequent restore will fail because of an inconsistent state. In this situation a transactional database should run the transactions from the write-ahead logs but I ran into this exact issue when testing this approach with Velero and Neo4j and was unable to complete the restore. Postgres and timescaledb also failed to restore using this approach. Implementing a primary backup and restore mechanism using the officially supported, native database tools (for neo4j the neo4j-backup utility) is my recommended approach.</p>

<p>For Neo4j, the community helm chart includes a child helm chart for backing up to AWS, GCP or Azure. The helm chart utilises the neo4j-admin backup image provided by Neo4j which runs as a sidecar to neo4j. That approach works well if you want to backup to these providers but if you are backing up to an alternative provider like Digital Ocean it might make more sense to start over and work towards an implementation that is customised to your environment, has less bloat and is easier to maintain. Here’s how I did it.</p>

<h2 id="kubernetes-cronjob-to-backup">Kubernetes CronJob to Backup</h2>

<p>For backup, I created a Kubernetes CronJob. The backup happens in two steps.</p>

<h3 id="step-1">Step 1:</h3>
<p>The neo4j-backup utility is run as an initialisation container. This produces an online backup which is written to a mounted volume. There is no downtime involved here but be aware that this will have performance implications on your running database. The schedule is set to meet the recovery point objective.</p>

<h3 id="step-2">Step 2:</h3>
<p>A custom container runs which copies the backup (from the mounted volume) to Digital Ocean S3 using s3cmd. The reason for the custom container here is that at the time of writing there was no easy way to set the s3cmd configuration values at runtime using the CLI so this is configured at the application layer and baked into the image.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: backupdir-neo4j
  labels:
    app: neo4j-backup
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: neo4j-backup
  namespace: neo4j
spec:
  schedule: "0 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
            - name: backupdir-neo4j
              persistentVolumeClaim:
                claimName: backupdir-neo4j
          initContainers:
            - name: neo4j-backup
              image: neo4j:4.2.8-enterprise
              env:
                - name: NEO4J_ACCEPT_LICENSE_AGREEMENT
                  value: "yes"
              volumeMounts:
              - name: backupdir-neo4j
                mountPath: /tmp
              command: ["/bin/sh", "-c"]
              args:
                - echo cleaning /tmp from PV;
                  rm -rf /tmp/*;
                  bin/neo4j-admin backup --backup-dir /tmp --database neo4j --from neo-neo4j.neo4j.svc.cluster.local:6362 --verbose;
                  echo backup completed
          containers:
            - name: copy-to-spaces
              image: registry.gitlab.com/custom-neo-backup-tool:latest
              imagePullPolicy: Always
              command: ["/bin/sh", "-c"]
              args:
                - yum install python36 -y;
                  pip3 install s3cmd;
                  cp /usr/app/s3cfg /root/.s3cfg;
                  s3cmd --config=/usr/app/s3cfg;
                  s3cmd put /tmp s3://path/to/backup/`date +%d%b%Y-%H:%M:%S`/ --recursive;
              volumeMounts:
              - name: backupdir-neo4j
                mountPath: /tmp
          imagePullSecrets: 
          - name: gitlab-registry-credentials  
          restartPolicy: OnFailure
</code></pre></div></div>

<h2 id="restore">Restore</h2>

<p>The restore process happens in two parts:</p>
<ol>
  <li>A initContainer runs in the helm chart to copy the data from S3.</li>
  <li>A command is run inside the POD to restore the backup</li>
</ol>

<h3 id="step-1-1">Step 1:</h3>
<p>The initContainer is a custom built image with the S3cmd config that copies the backup specified into the plugins mount. Note that the path to the backup in the s3cmd get command needs to be specified.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: custom-neo-recovery-tool
    image: registry.gitlab.com/custom-neo-backup-tool
    imagePullPolicy: Always
    volumeMounts:
    - name: plugins
      mountPath: /plugins
    command: ["/bin/sh", "-c"]
    args:
      - yum install python36 -y;
        pip3 install s3cmd;
        cp /usr/app/s3cfg /root/.s3cfg;
        s3cmd --config=/usr/app/s3cfg;
        s3cmd get --recursive --force s3://path/to/backup/timestamp/ /plugins;
</code></pre></div></div>

<h3 id="step-2-1">Step 2:</h3>
<p>Once the neo core has started to perform the recovery:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. In CYPHER-SHELL OR NEO4j BROWSER run: STOP DATABASE {name}
2. On Pod run: bin/neo4j-admin restore --from /plugins/tmp/neo4j --database neo4j --force;
3. In CYPHER-SHELL or NEO4J BROWSER run: START DATABASE {name}
</code></pre></div></div>]]></content><author><name>James Hope</name></author><category term="Kubernetes," /><category term="Neo4j," /><category term="Solution" /><category term="Architecture" /><summary type="html"><![CDATA[If you’re managing a data engine inside a kubernetes cluster then implementing a backup and restore process can be challenging. A few months ago I developed a solution architecture deploying Neo4j into Kubernetes as a casual cluster. There’s a Medium post by Neo4j’s David Allen to explain what that configuration looks like here. Unfortunately Neo4j doesn’t officially support a casual cluster deployment, but there are community maintained helm charts endorsed by Neo4j that make this achieveable. For this solution I needed a simple backup and restore (nothing more) which is what I wanted to focus on here.]]></summary></entry><entry><title type="html">Top 10 architectural highlights for Digital Ocean Kubernetes</title><link href="http://localhost:4000/kubernetes,/digital/ocean,/solution/architecture/kubernetes-digital-ocean/" rel="alternate" type="text/html" title="Top 10 architectural highlights for Digital Ocean Kubernetes" /><published>2021-10-27T20:46:34+01:00</published><updated>2021-10-27T20:46:34+01:00</updated><id>http://localhost:4000/kubernetes,/digital/ocean,/solution/architecture/kubernetes-digital-ocean</id><content type="html" xml:base="http://localhost:4000/kubernetes,/digital/ocean,/solution/architecture/kubernetes-digital-ocean/"><![CDATA[<p>Recently I’ve been developing a solution architecture for a boostrapped startup in Digital Ocean’s Kubernetes. Developing an understanding of the context, discovering the domain and taking initial ideas through critical design thinking has been key to a foundational architecture that should serve this product well throughout its lifecycle. As envisioning has happened, the solution and its architecture has evolved to enable numerous product iterations, building out only what has been necessary at each stage. The domain driven approach to development led to a server based query gateway and so what unfolded was containerised microservcies architecture orchestrated by Kubernetes. Here are my top 10 highlights from building in Digital Ocean Kubernetes:</p>

<p><img src="/assets/images/containers.jpg" alt="GitHub Logo" />
Source: https://www.pexels.com/</p>

<h3 id="10-utilise-external-infrastructure-for-completeness-when-necessary">10. Utilise external infrastructure for completeness when necessary</h3>

<p>The absence of key architectural components to deploy in front of the cluster is a limitation to be aware with Digital Ocean. If you are building for production route traffic via services you can route traffic through CloudFlare, for example, for a layer 7 firewall, OWASP compliance and global server load balancing.</p>

<h3 id="9-work-from-the-application-resource-requirements-to-determine-the-minimum-viable-infrastructure">9. Work from the application resource requirements to determine the minimum viable infrastructure</h3>

<p>If like most you have machine specifications to provision into your cluster (AWS Fargate the notable exception) then it makes sense to understand what resources your applications need and then work down the stack. One approach is to group applications into logical planes - Control, User, Data plane - to determine what resources are needed in each plane. Also look to vendors and application specifications for guidance on resource and scaling requirements.</p>

<h3 id="8-consider-the-velocity-of-scaling-in-the-vertical-and-horizonal-directions-and-the-impact-on-services">8. Consider the velocity of scaling in the vertical and horizonal directions and the impact on services</h3>

<p>For horizontal scaling there is speed to think about: kubernetes will replicate pods across nodes in a matter of seconds but if new nodes are required to achieve that replication that it can take minutes. The trade-off here is between performance efficiency and cost optimisation. Set the autoscaling thresholds so there is enough spare capacity in the pods to allow time for the autoscaling to happen or provision larger nodes that enable sideways replication of pods on that same node. Develop event driven microservices with messaging queues to add resiliency. In production, use metrics to determine and refine the right vertical and horizontal thresholds.</p>

<h3 id="7-strive-for-the-rule-of-three-for-high-availability">7. Strive for the ‘rule of three’ for high availability</h3>

<p>For a production and staging deployment I like to follow the rule of three. Three nodes in three availability zones with three pod replicas in each zone. For stateful applications being deployed into a cluster configuration it is recommended to have three cores or leader-eligible instances to avoid split brain.</p>

<h3 id="6-build-with-open-source-multi-vendor-or-community-developed-applications-for-portability">6. Build with open-source, multi-vendor or community-developed applications for portability</h3>

<p>If you can build with open-source, multi-vendor and community-developed applications you can avoid vendor lock-in and keep the door open to other clouds as needs evolve over time. For example, in my case, building with Hasura GraphQL rather than AWS AppSync as a graph QL gateway, and Neo4J rather than AWS Neptune as a graph data engine.</p>

<h3 id="5-avoid-constraints-and-design-with-soft-intent-for-scheduling-flexibility">5. Avoid constraints and design with soft intent for scheduling flexibility</h3>

<p>Imposing hard constraints such as anti-affinity rules, taints and tolerations could result in a pod being unschedulable. Unless you need to import hard constraints use soft requirements such as topology keys to describe scheduling intent and best effort across nodes.</p>

<h3 id="4-strive-to-understand-the-limitations-of-the-network-backbone">4. Strive to understand the limitations of the network backbone</h3>

<p>Be aware of the limitations of the backbone. Public clouds vary significantly in their network speed. All the autoscaling in the world won’t help if the bottleneck is the backbone.</p>

<h3 id="3-use-a-service-mesh-for-resiliency">3. Use a service mesh for resiliency</h3>

<p>Since Digital Ocean doesn’t provision Kubernetes with the Kubernetes Networking Plugin a single control plane is limited to orchestrating pods across a single availability zone. That doesn’t need to be an impediment to high availibility though, since with a service mesh (e.g., Traefik, Itsio or Consul) high availibilility can be achieved through the service mesh gateways that enable applications to connect to services that route to pods in clusters in other regional data centers. Relying on the service mesh for service availability could be a good trade-off if the only way to achieve control plane replication and orchestration across availablility zones means looking to more mature and costly platforms. Bear in mind that in a mesh, as applications run at the edge, regional data centers start behaving a bit like secondary availability zones.</p>

<h3 id="2-use-managed-services-to-abstract-devops-from-infrastructure-details">2. Use managed services to abstract devOps from infrastructure details</h3>

<p>Understanding the ops environment that the solution is being deployed into is key for a successful operation. If the ops environment is not assessed to be ready to operate the applications being proposed, moving them into a managed service can be a good option. This is where the marketplace shines because self-managing data engines (especially in clustered or fully distributed configurations) would most certainly warrant a dedicated team of site reliability engineers trained on the native technology, its disaster recovery procedures amongst other things. As a managed service however, availability, scaling, and disaster recovery (including point-in-time recovery to the nearest second) are trivial to configure. My view is that money is well spent here to abstract debt-laden DevOps from application infrastructure and to enable the focus firmly on the product and hypothesis-driven development.</p>

<h3 id="1-use-a-favourable-pricing-model-to-get-into-production">1. Use a favourable pricing model to get into production</h3>

<p>For whatever Digital Ocean might lack in edge services and availability zones it makes up for in infrastructure costs. VM pricing per hour is competitive even against the usage discounting applied by the major public cloud providers to the extent that it could extend the of life of a startup and its funding significantly. The virtual private cloud is provided at no cost and data egress is not chargable, which depending on what you are building, could present a significant cost saving (though be way of the limits of the network).  Building with open-source, multi-vendor and community-developed applications on an open platform means porting to another cloud is an option later on when services at the edge and secondary availability zones is probably going to make more sense anyway.</p>]]></content><author><name>James Hope</name></author><category term="Kubernetes," /><category term="Digital" /><category term="Ocean," /><category term="Solution" /><category term="Architecture" /><summary type="html"><![CDATA[Recently I’ve been developing a solution architecture for a boostrapped startup in Digital Ocean’s Kubernetes. Developing an understanding of the context, discovering the domain and taking initial ideas through critical design thinking has been key to a foundational architecture that should serve this product well throughout its lifecycle. As envisioning has happened, the solution and its architecture has evolved to enable numerous product iterations, building out only what has been necessary at each stage. The domain driven approach to development led to a server based query gateway and so what unfolded was containerised microservcies architecture orchestrated by Kubernetes. Here are my top 10 highlights from building in Digital Ocean Kubernetes:]]></summary></entry><entry><title type="html">A New Era for People Analytics</title><link href="http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j/a-new-era-for-people-analytics/" rel="alternate" type="text/html" title="A New Era for People Analytics" /><published>2019-08-21T20:46:34+01:00</published><updated>2019-08-21T20:46:34+01:00</updated><id>http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j/a-new-era-for-people-analytics</id><content type="html" xml:base="http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j/a-new-era-for-people-analytics/"><![CDATA[<p>This article was published in the journal Towards Data Science. Please click <a target="_new" href="https://towardsdatascience.com/the-dawn-of-a-new-era-for-people-analytics-9a748f7fdc2">here</a> to access the article.</p>]]></content><author><name>James Hope</name></author><category term="Medium," /><category term="TowardsDataScience," /><category term="PeopleAnalytics," /><category term="Graphs," /><category term="Neo4j" /><summary type="html"><![CDATA[This article was published in the journal Towards Data Science. Please click here to access the article.]]></summary></entry><entry><title type="html">Can your People Analytics do this?</title><link href="http://localhost:4000/medium,/towardsdatascience,/people/analytics/can-your-people-analytics-do-this/" rel="alternate" type="text/html" title="Can your People Analytics do this?" /><published>2019-08-02T20:46:34+01:00</published><updated>2019-08-02T20:46:34+01:00</updated><id>http://localhost:4000/medium,/towardsdatascience,/people/analytics/can-your-people-analytics-do-this</id><content type="html" xml:base="http://localhost:4000/medium,/towardsdatascience,/people/analytics/can-your-people-analytics-do-this/"><![CDATA[<p>This article was published in the journal Towards Data Science. Please click <a target="_new" href="https://towardsdatascience.com/can-your-people-analytics-do-this-739afa714f1a">here</a> to access the article.</p>]]></content><author><name>James Hope</name></author><category term="Medium," /><category term="TowardsDataScience," /><category term="People" /><category term="Analytics" /><summary type="html"><![CDATA[This article was published in the journal Towards Data Science. Please click here to access the article.]]></summary></entry><entry><title type="html">Build a Machine Learning Recommender</title><link href="http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j,/machinelearning,/recommendersystems,/recommender/build-a-machine-learning-recommender/" rel="alternate" type="text/html" title="Build a Machine Learning Recommender" /><published>2019-07-29T20:46:34+01:00</published><updated>2019-07-29T20:46:34+01:00</updated><id>http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j,/machinelearning,/recommendersystems,/recommender/build-a-machine-learning-recommender</id><content type="html" xml:base="http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j,/machinelearning,/recommendersystems,/recommender/build-a-machine-learning-recommender/"><![CDATA[<p>This article was published in the journal Towards Data Science. Please click <a target="_new" href="https://towardsdatascience.com/build-a-machine-learning-recommender-72be2a8f96ed">here</a> to access the article.</p>]]></content><author><name>James Hope</name></author><category term="Medium," /><category term="TowardsDataScience," /><category term="PeopleAnalytics," /><category term="Graphs," /><category term="Neo4j," /><category term="MachineLearning," /><category term="RecommenderSystems," /><category term="Recommender" /><summary type="html"><![CDATA[This article was published in the journal Towards Data Science. Please click here to access the article.]]></summary></entry><entry><title type="html">Build your own Blockchain Protocol</title><link href="http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j/build-your-own-blockchain-protocol/" rel="alternate" type="text/html" title="Build your own Blockchain Protocol" /><published>2019-07-02T20:46:34+01:00</published><updated>2019-07-02T20:46:34+01:00</updated><id>http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j/build-your-own-blockchain-protocol</id><content type="html" xml:base="http://localhost:4000/medium,/towardsdatascience,/peopleanalytics,/graphs,/neo4j/build-your-own-blockchain-protocol/"><![CDATA[<p>This article was published in the journal Towards Data Science. Please click <a target="_new" href="https://towardsdatascience.com/build-your-own-blockchain-protocol-for-a-distributed-ledger-54e0a92e1f10">here</a> to access the article.</p>]]></content><author><name>James Hope</name></author><category term="Medium," /><category term="TowardsDataScience," /><category term="PeopleAnalytics," /><category term="Graphs," /><category term="Neo4j" /><summary type="html"><![CDATA[This article was published in the journal Towards Data Science. Please click here to access the article.]]></summary></entry><entry><title type="html">Implementation of the Stable Marriage Algorithm to find ‘Stable Groups’</title><link href="http://localhost:4000/edtech,/coding,/programming,/python,/computing,/computer-science/StableGroups/" rel="alternate" type="text/html" title="Implementation of the Stable Marriage Algorithm to find ‘Stable Groups’" /><published>2018-05-05T20:46:34+01:00</published><updated>2018-05-05T20:46:34+01:00</updated><id>http://localhost:4000/edtech,/coding,/programming,/python,/computing,/computer-science/StableGroups</id><content type="html" xml:base="http://localhost:4000/edtech,/coding,/programming,/python,/computing,/computer-science/StableGroups/"><![CDATA[<p>In my previous post, I explained my implementation of the Stable Marriage Algorithm to find stable pairs. Taking this implementation one step further, I wanted to use the Stable Marriage Algorithm iteratively, to join stable pairs to other stable pairs to forms groups (or sets). This post explains my implementation of how I have used the Stable Marriage Algorithm to form groups of stable pairs.</p>

<h1>Basic Software Architecture</h1>

<p>We will make use of my implementation of the Stable Marriage Algorithm. As before, we will need class objects for holding the proposer and acceptor preferences, as well as the list of engagements (or pairs). Additionally, we will need a class object to hold the list of pairs for iteration of the algorithm. We will call this the Pools Class and it will hold Pool Class Objects (or the pairs found at each level).</p>

<p>Another important aspect of this design is that as we will alterate running the Stable Pairs Algorithm over all proposals and then over proposals of proposers that have not been previously matched in a Stable Pair. This will ensure that these unmatched proposers (or orphans) are given a bit more help in being matched in a Stable Pair for each iteration of the algorithm. So the basic architecture will look something like this:</p>

<p><img src="https://raw.githubusercontent.com/jamesdhope/jamesdhope.github.io/master/_posts/SA2.jpg" /></p>

<h1>Example Data</h1>

<p>Let’s consider the preferences are now set out as as follows. The preferences will form both the Proposers Table and the Acceptors Table (a mirror copy).</p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg .tg-us36{vertical-align:top}
.tg .tg-xxzo{background-color:#c0c0c0;vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-xxzo">Johnny</th>
    <th class="tg-us36">Barry</th>
    <th class="tg-us36">Charlie</th>
    <th class="tg-us36">Gilly</th>
    <th class="tg-us36">null</th>
    <th class="tg-us36">null</th>
  </tr>
  <tr>
    <td class="tg-xxzo">Alphie</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
  </tr>
  <tr>
    <td class="tg-xxzo">Barry</td>
    <td class="tg-us36">Alphie</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
  </tr>
  <tr>
    <td class="tg-xxzo">Charlie</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">Alphie</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
  </tr>
  <tr>
    <td class="tg-xxzo">Danny</td>
    <td class="tg-us36">Charlie</td>
    <td class="tg-us36">Elle</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
  </tr>
  <tr>
    <td class="tg-xxzo">Freddie</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">Gilly</td>
    <td class="tg-us36">Danny</td>
  </tr>
  <tr>
    <td class="tg-xxzo">Gilly</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">Johnny</td>
    <td class="tg-us36">Freddie</td>
    <td class="tg-us36">null</td>
  </tr>
  <tr>
    <td class="tg-xxzo">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
    <td class="tg-us36">null</td>
  </tr>
</table>

<p>From this input file, what we would like to be able to produce is a list of sets that is formed from joining stable pairs to other stable pairs. So the sets that would be formed would be as follows:</p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg .tg-us36{vertical-align:top}
.tg .tg-xxzo{background-color:#c0c0c0;vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-xxzo">Set 1</th>
    <th class="tg-xxzo">Set 2</th>
    <th class="tg-xxzo">Set 3</th>
    <th class="tg-xxzo">Set 4</th>
    <th class="tg-xxzo">Set 5</th>
</tr>
  <tr>
    <th class="tg-us36">Alphie</th>
    <th class="tg-us36">Barry</th>
    <th class="tg-us36">Charlie</th>
    <th class="tg-us36">Danny</th>
    <th class="tg-us36">Gilly</th>

  </tr>
  <tr>
        <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36">Elle</th>
    <th class="tg-us36">Johnny</th>
  </tr>
  <tr>
            <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36">Freddie</th>
  </tr>
</table>

<h1>A Data Structure for holding Stable Pairs</h1>

<p>Now let’s dive into the python. First we will need to make use of some libraries.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">sets</span>
<span class="kn">import</span> <span class="nn">copy</span></code></pre></figure>

<p>The Pool Class Object will hold all of the Stable Paris that are found for each run of the Stable Pairs Algorithm. The methods for this class object will manage and update the pairings.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Pool Class :: holds engagements
</span><span class="k">class</span> <span class="nc">Pool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acceptors</span><span class="p">):</span>
        <span class="s">"""
        Construct an array which will hold the engagements. Instatiate each maximum preference number that 
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">acceptors</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">new_engagement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">):</span>
        <span class="s">"""
        Update (replace) the engagement in the pool 
        """</span>
        <span class="c1">#print("entering new engagement")
</span>        <span class="k">if</span> <span class="n">proposer</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">:</span>
            <span class="c1">#print("new engagement1")
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">.</span><span class="n">tolist</span><span class="p">().</span><span class="n">index</span><span class="p">(</span><span class="n">proposer</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">acceptor</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">:</span>
            <span class="c1">#print("new engagement2")
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">.</span><span class="n">tolist</span><span class="p">().</span><span class="n">index</span><span class="p">(</span><span class="n">acceptor</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">[</span><span class="n">acceptor</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">proposer</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">[</span><span class="n">proposer</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">acceptor</span>
        <span class="c1">#print("new engagement made")
</span>
    <span class="k">def</span> <span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Return True if complete
        """</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">).</span><span class="nb">any</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">not_engaged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">proposer</span><span class="p">):</span>
        <span class="s">"""
        Return True if engaged otherwise False
        """</span>
        <span class="k">if</span> <span class="n">proposer</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">get_current_engagement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">acceptor</span><span class="p">):</span> 
        <span class="s">"""
        Return the current engagement for a acceptor
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span><span class="p">[</span><span class="n">acceptor</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_all_engagements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Return all the current engagements
        """</span>        
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">engagements</span></code></pre></figure>

<h1>A Data Structure for holding Preferences</h1>

<p>The Acceptor Class object will hold all of the preferences. The is_proposal_accepted() is an important method which deserves some attention here.</p>

<p>For a proposal to be accepted, is must not cause a set size that exceeds the max_set_size. This is handled by the function is_set_size_allowed() which is explained in a bit more detail later. If the proposal would not cause a set size that exceeds the max_set_size then for the proposal to be accepted, one of the two following conditions must be met:</p>
<ol>
  <li>The proposer and acceptor must be either unmatched; they must have listed each other in their preferences; and, they must not have already been paired in a previous iteration of the Stable Marriage Algorithm. Or:</li>
  <li>They must have listed each other in their preferences and the proposal must be better than the current proposal.</li>
</ol>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Acceptor Class :: holds the acceptor preferences
</span><span class="k">class</span> <span class="nc">Acceptor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">values</span><span class="p">):</span>
        <span class="s">"""
        Construct the acceptor preferences
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">get_preference_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">null_position</span><span class="p">):</span>
        <span class="s">"""
        Return the preference of the acceptor for the proposer passed. Return 0 if value is null or if the preference is not in the list.
        """</span>
        <span class="c1">#if (proposer==null_position) or (acceptor==null_position): 
</span>        <span class="c1">#    return 0
</span>
        <span class="k">if</span> <span class="n">proposer</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">acceptor</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">acceptor</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">index</span><span class="p">(</span><span class="n">proposer</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">is_proposal_accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">pool_object</span><span class="p">,</span><span class="n">pools_object</span><span class="p">,</span><span class="n">null_position</span><span class="p">,</span><span class="n">orphan_round</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">preference</span><span class="p">,</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">):</span>
        <span class="s">"""
        If proposer is in accepter preferences return true else return false
        """</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"position of preference in acceptor table (for proposal):"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"acceptor is currently engaged to:"</span><span class="p">,</span> <span class="n">pool_object</span><span class="p">.</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"position of preference in acceptor table (for current engagement):"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">)))</span>

        <span class="c1">#check if the proposal would create a set size that exceeds the maximum set size and if so return false
</span>        <span class="k">if</span> <span class="n">is_set_size_allowed</span><span class="p">(</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">pool_object</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">preference</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">,</span><span class="n">pools_object</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">)</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">orphan_round</span><span class="p">:</span> 
            <span class="c1"># If Orphan then If Engagements empty accept, Elseif better than current engagement accept; Else reject (i.e. not listed)
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">proposer</span><span class="p">))</span> <span class="ow">and</span> <span class="n">pools_object</span><span class="p">.</span><span class="n">is_orphan</span><span class="p">(</span><span class="n">proposer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pools_object</span><span class="p">.</span><span class="n">is_valid_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">null_position</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">pools_object</span><span class="p">.</span><span class="n">is_orphan</span><span class="p">(</span><span class="n">proposer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pools_object</span><span class="p">.</span><span class="n">is_valid_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">null_position</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">null_position</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">),</span><span class="n">null_position</span><span class="p">)))):</span> 
                <span class="k">return</span> <span class="bp">True</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Same logic as above but do not restrict to orphans
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">proposer</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">null_position</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pools_object</span><span class="p">.</span><span class="n">is_valid_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">pools_object</span><span class="p">.</span><span class="n">is_valid_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">null_position</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">null_position</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_preference_number</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">),</span><span class="n">null_position</span><span class="p">)))):</span> 
                <span class="k">return</span> <span class="bp">True</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span></code></pre></figure>

<p>As before, the Proposers Class Object holds the list of proposals. There is no change here.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Proposer Class :: holds the proposer preferences
</span><span class="k">class</span> <span class="nc">Proposer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="s">"""
        Construct the proposer preferences
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">get_proposal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">iteration</span><span class="p">):</span>
        <span class="s">"""
        Return the acceptor value (proposal to try) for the proposer and iteration passed
        """</span>
        <span class="c1">#print("proposer",proposer,"iteration",iteration,"result",self.values[proposer][iteration])
</span>        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">proposer</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span></code></pre></figure>

<h1>A Data Structure for holding previously found Stable Pairs</h1>

<p>The Pools Class Object will hold the list of Pool Class Objects. The is_valid_engagement() is called to check if a member exists in a Stable Pair in a previous Pool Class Object.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Pools Class :: holds pool (engagement) objects  
</span><span class="k">class</span> <span class="nc">Pools</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Construct the proposer preferences
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Return the length of the pools set
        """</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pool_object</span><span class="p">):</span>
        <span class="s">"""
        Add pool objects to the Pools object class
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool_object</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">remove_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Remove last object added to values
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_valid_engagement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">acceptor</span><span class="p">,</span><span class="n">proposer</span><span class="p">):</span>
        <span class="s">"""
        If already engaged to proposer in previous iteration; otherwise return True
        """</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">)):</span>   
            <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">acceptor</span><span class="p">)</span><span class="o">==</span><span class="n">proposer</span><span class="p">:</span> 
                <span class="k">return</span> <span class="bp">False</span> <span class="c1">#if found don't allow engagement
</span>        
        <span class="k">return</span> <span class="bp">True</span> 
        
    <span class="k">def</span> <span class="nf">is_orphan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">proposer</span><span class="p">):</span>
        <span class="s">"""
        Check if the proposer appears on any previous set of engagements (pool) and if so return True to indicate orphan
        """</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">)):</span>   
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_current_engagement</span><span class="p">(</span><span class="n">proposer</span><span class="p">)):</span> 
                <span class="k">return</span> <span class="bp">False</span>  <span class="c1">#if found don't allow engagement
</span>        <span class="k">return</span> <span class="bp">True</span> 

    <span class="k">def</span> <span class="nf">get_pool_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pool_object_number</span><span class="p">):</span>
        <span class="s">"""
        Return the pool object from the pools class
        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">pool_object_number</span><span class="p">]</span></code></pre></figure>

<h1>Routines for importing &amp; encoding the preference data</h1>

<p>Next, we have a few functions that import the preferences from file, encode and decode the input data as strings to integer values.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">import_preferences</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
    <span class="s">"""
        Read the data from file and return the names and preferences
    """</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">preferences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Input file read from file </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">preferences</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>    
            <span class="n">names</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">preferences</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
    <span class="s">"""
    Return the index of the name in the list of names
    """</span>
    <span class="k">return</span> <span class="n">names</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">return_null_position</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
    <span class="s">"""
    Return tye position of the null value
    """</span>
    <span class="k">return</span> <span class="n">names</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="s">"null"</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">encode_preferences</span><span class="p">(</span><span class="n">preferences</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">):</span>
    <span class="s">"""
    Encode the preferences 
    """</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">preferences</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">encode</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
    <span class="s">"""
    Return the index of the name in the list of names
    """</span>
    <span class="k">return</span> <span class="n">names</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span><span class="n">names</span><span class="p">):</span>
    <span class="s">"""
    Decode the engagements
    """</span>  
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pairs</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>  
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pairs</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>    
    <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dec</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span> <span class="c1">#decode engagements (ignore negative values)
</span>    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">tolist</span><span class="p">())</span></code></pre></figure>

<h1>Routines for forming sets from stable pairs</h1>

<p>We will some functions to build the Stable Pairs found at each iteration of the Stable Marriage Algorithm into sets. The function build_pairs returns a dataframe with the stable pairs found at each iteration. The function build_groups then loops through all of the pairs and joins these to previously joined pairs. The Python sets library is ideal for this as the union of two sets implicitly removes any duplication.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">build_pairs</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">pools_object</span><span class="p">):</span>
    <span class="s">"""
    Build a list of all stable pairs by fetching pairs from each pool_object in the pools_object
    """</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pools_object</span><span class="p">.</span><span class="n">length</span><span class="p">()):</span>
        <span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">decode</span><span class="p">(</span><span class="n">pools_object</span><span class="p">.</span><span class="n">get_pool_object</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">get_all_engagements</span><span class="p">(),</span> <span class="n">names</span><span class="p">)).</span><span class="n">flatten</span><span class="p">()</span> <span class="c1">#pd.DataFrame(data=engagements)  
</span>
    <span class="k">return</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_if_intersection</span><span class="p">(</span><span class="n">set_1</span><span class="p">,</span><span class="n">set_2</span><span class="p">):</span>
    <span class="s">"""
    Returns true if an intersection between two lists is found, otherwise false
    """</span>
    <span class="n">set1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">set_1</span><span class="p">)</span>
    <span class="n">set2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">set_2</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">set1</span><span class="p">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">set2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="s">"null"</span> <span class="ow">in</span> <span class="n">set1</span><span class="p">)</span> <span class="ow">and</span><span class="p">(</span><span class="ow">not</span> <span class="s">"null"</span> <span class="ow">in</span> <span class="n">set2</span><span class="p">)):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">get_union</span><span class="p">(</span><span class="n">set_1</span><span class="p">,</span><span class="n">set_2</span><span class="p">):</span>
    <span class="s">"""
    Returns the union of two lists
    """</span>
    <span class="n">set1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">set_1</span><span class="p">)</span>
    <span class="n">set2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">set_2</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">set1</span><span class="p">.</span><span class="n">union</span><span class="p">(</span><span class="n">set2</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s">"null"</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">result</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="s">"null"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">build_groups</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">pairs</span><span class="p">,</span><span class="n">pools_object</span><span class="p">):</span>
    <span class="s">"""
    From the pairs data, build lists of sets and return the set lists (provided there are more than 2 columns)
    """</span>
    <span class="n">sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">"null"</span><span class="p">)</span>
    
    <span class="c1">#only perform traverse if we have a minimum of two columns
</span>    <span class="k">if</span> <span class="n">pairs</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        
        <span class="c1">#create sets for members at first level
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_union</span><span class="p">(</span><span class="nb">list</span><span class="p">([</span><span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]),</span><span class="nb">list</span><span class="p">([</span><span class="n">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]])))</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
                <span class="n">sets</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="c1">#print("output of level1 join", sets)
</span>    
        <span class="c1"># Now join level2, level3 etc members and maintain the trees
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">pools_object</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#or   #pairs.shape[1]
</span>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
                <span class="n">index_to_join</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">index_to_remove</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
                <span class="c1">#check if the student is already in a set somewhere else and if so get the index of that set
</span>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">index_to_remove</span> <span class="o">=</span> <span class="n">k</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"index to remove"</span><span class="p">,</span> <span class="n">index_to_remove</span><span class="p">)</span>
    
                <span class="c1">#get the index of the set the student is already in 
</span>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">index_to_join</span> <span class="o">=</span> <span class="n">k</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"index to join"</span><span class="p">,</span><span class="n">index_to_join</span><span class="p">)</span>
    
                <span class="k">if</span> <span class="p">(</span><span class="n">index_to_join</span><span class="o">==</span><span class="n">index_to_remove</span><span class="p">):</span>
                    <span class="c1">#print("idex to join = index to remove")
</span>                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="p">((</span><span class="n">index_to_remove</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_to_join</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)):</span>
                    <span class="n">sets</span><span class="p">[</span><span class="n">index_to_join</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_union</span><span class="p">(</span><span class="n">sets</span><span class="p">[</span><span class="n">index_to_join</span><span class="p">],</span><span class="n">sets</span><span class="p">[</span><span class="n">index_to_remove</span><span class="p">]))</span>
                    <span class="n">sets</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index_to_remove</span><span class="p">)</span> 
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sets</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span> </code></pre></figure>

<h1>The Stable Pairs Algorithm</h1>

<p>The stable_marriage function will call the stable_pairs function over and over again according to the number of iterations defined. For each iteration, the stable_pairs function is called twice. The first time, we attempt for find stable pairs for each member in the dataset. The second time, we attempt to find stable pairs for members in the dataset that have not yet been paired (at any level).</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">stable_pairs</span><span class="p">(</span><span class="n">pool_object</span><span class="p">,</span><span class="n">pools_object</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">,</span><span class="n">proposers_table</span><span class="p">,</span><span class="n">accepter_object</span><span class="p">,</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">,</span><span class="n">null_position</span><span class="p">,</span><span class="n">orphan_round</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">,</span><span class="n">names</span><span class="p">):</span>
    <span class="s">"""
    Create stable engagements and return the list
    """</span>
    <span class="k">for</span> <span class="n">preference</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"/n PREFERENCE:"</span><span class="p">,</span> <span class="n">preference</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#print("width",range(len(proposers_table[preference])))
</span>        <span class="k">for</span> <span class="n">proposer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">proposers_table</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">pool_object</span><span class="p">.</span><span class="n">not_engaged</span><span class="p">(</span><span class="n">proposer</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"PROPOSAL:"</span><span class="p">,</span> <span class="n">proposer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">"----&gt;"</span><span class="p">,</span> <span class="n">proposers_table</span><span class="p">[</span><span class="n">proposer</span><span class="p">][</span><span class="n">preference</span><span class="p">])</span>        
                
                <span class="k">if</span> <span class="n">accepter_object</span><span class="p">.</span><span class="n">is_proposal_accepted</span><span class="p">(</span><span class="n">proposer_object</span><span class="p">.</span><span class="n">get_proposal</span><span class="p">(</span><span class="n">proposer</span><span class="p">,</span><span class="n">preference</span><span class="p">),</span><span class="n">proposer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">pool_object</span><span class="p">,</span><span class="n">pools_object</span><span class="p">,</span><span class="n">null_position</span><span class="p">,</span><span class="n">orphan_round</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">preference</span><span class="p">,</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">):</span> <span class="c1">#if proposal is accepter
</span>                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"PROPOSAL ACCEPTED"</span><span class="p">)</span>
                    <span class="n">pool_object</span><span class="p">.</span><span class="n">new_engagement</span><span class="p">(</span><span class="n">proposer_object</span><span class="p">.</span><span class="n">get_proposal</span><span class="p">(</span><span class="n">proposer</span><span class="p">,</span><span class="n">preference</span><span class="p">),</span><span class="n">proposer</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"PROPOSAL FAILED"</span><span class="p">)</span>

                <span class="c1">#print(pool_object.get_all_engagements())
</span>
            <span class="k">if</span> <span class="n">pool_object</span><span class="p">.</span><span class="n">is_complete</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">pool_object</span>

    <span class="k">return</span> <span class="n">pool_object</span>

<span class="k">def</span> <span class="nf">stable_marriage</span><span class="p">(</span><span class="n">pools_object</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">,</span><span class="n">proposers_table</span><span class="p">,</span><span class="n">accepter_object</span><span class="p">,</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">iteration</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">,</span><span class="n">null_position</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">,</span><span class="n">names</span><span class="p">):</span>
    <span class="s">"""
    Call the stable_pairs function iteratively and update the Pools object
    """</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iteration</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">"ITERATION:"</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># add pool object with stable pairs
</span>        <span class="n">pool_object</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">acceptors_table</span><span class="p">)</span> <span class="c1">#create a pool object
</span>        <span class="n">pools_object</span><span class="p">.</span><span class="n">add_pool</span><span class="p">(</span><span class="n">stable_pairs</span><span class="p">(</span><span class="n">pool_object</span><span class="p">,</span><span class="n">pools_object</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">,</span><span class="n">proposers_table</span><span class="p">,</span><span class="n">accepter_object</span><span class="p">,</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">,</span><span class="n">null_position</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">,</span><span class="n">names</span><span class="p">))</span> <span class="c1">#call stable pairs
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Engagements (all members) found at iteration {} </span><span class="se">\n</span><span class="s"> {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_all_engagements</span><span class="p">()))</span>
        
        <span class="c1"># add pool object with orphans
</span>        <span class="n">pool_object</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">acceptors_table</span><span class="p">)</span> <span class="c1">#create a pool object
</span>        <span class="n">pools_object</span><span class="p">.</span><span class="n">add_pool</span><span class="p">(</span><span class="n">stable_pairs</span><span class="p">(</span><span class="n">pool_object</span><span class="p">,</span><span class="n">pools_object</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">,</span><span class="n">proposers_table</span><span class="p">,</span><span class="n">accepter_object</span><span class="p">,</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">,</span><span class="n">null_position</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">,</span><span class="n">names</span><span class="p">))</span> <span class="c1">#call stable pairs
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Engagements (Orpans) found at iteration {} </span><span class="se">\n</span><span class="s"> {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">pool_object</span><span class="p">.</span><span class="n">get_all_engagements</span><span class="p">()))</span></code></pre></figure>

<p>As we find stable_pairs and accept proposals, we must also check that a proposal would not create a set size that exceeds the max_set_size. To do this, we make a deep copy of the Pools and Pool Objects and call the build_groups and build_pairs functions to return a dataframe with the sets. Unfortunately calling this function each time we make a proposal is computationally inefficient but we will need to check.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">is_set_size_allowed</span><span class="p">(</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">pool_object</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">preference</span><span class="p">,</span><span class="n">proposer</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">,</span><span class="n">pools_object</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">):</span>
    <span class="s">"""
    If engagement creates a set size that exeeds max_set_size return False; otherwise return True 
    """</span>
    <span class="c1"># create dummy pool and pools
</span>    <span class="n">pool_test</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">acceptors_table</span><span class="p">)</span>
    <span class="n">pool_test</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">pool_object</span><span class="p">)</span>     
    <span class="n">pool_test</span><span class="p">.</span><span class="n">new_engagement</span><span class="p">(</span><span class="n">proposer_object</span><span class="p">.</span><span class="n">get_proposal</span><span class="p">(</span><span class="n">proposer</span><span class="p">,</span><span class="n">preference</span><span class="p">),</span><span class="n">proposer</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">pools_test</span> <span class="o">=</span> <span class="n">Pools</span><span class="p">()</span>
    <span class="n">pools_test</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">pools_object</span><span class="p">)</span>  
    <span class="n">pools_test</span><span class="p">.</span><span class="n">add_pool</span><span class="p">(</span><span class="n">pool_test</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">build_groups</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">build_pairs</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">pools_test</span><span class="p">),</span><span class="n">pools_test</span><span class="p">))</span><span class="o">&gt;</span><span class="n">max_set_size</span><span class="p">):</span>        
        <span class="c1">#print(build_groups(names,build_pairs(names,pools_object),pools_object))        
</span>        <span class="k">return</span> <span class="bp">False</span>
        
    <span class="k">del</span> <span class="n">pool_test</span>
    <span class="k">del</span> <span class="n">pools_test</span>
        
    <span class="k">return</span> <span class="bp">True</span></code></pre></figure>

<p>Finally we can call the import routines, encode the input data, instantiate the Pools Class Object and call the stable_marriage function to run the algorithm. A few simple tweaks here would make it possible for us to run the program from the Command Line.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="s">"Preferences4.csv"</span>
        <span class="c1">#input_file = sys.argv[1]
</span>        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="c1">#iteration = int(sys.argv[2]) # Number of runs of stable pairs algoirthm. Subsequent runs ignore stable pairs already built.
</span>        <span class="n">no_of_preferences</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c1">#no_of_preferences = int(sys.argv[3]) # Number of preferences to read from input file
</span>        <span class="n">max_set_size</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="c1">#max_set_size = int(sys.argv[4]) # Maximum number in a set
</span>        
    <span class="k">except</span><span class="p">:</span> 
        <span class="k">print</span><span class="p">(</span><span class="s">"stableGroups.py --[input_file] --[iteration] --[no_of_preferences] --[max_set_size]</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"--[input_file] </span><span class="se">\n</span><span class="s"> input file in csv format </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"--[iteration] </span><span class="se">\n</span><span class="s"> number of runs of Stable Pairs Algorithm </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"--[no_of_preferences] </span><span class="se">\n</span><span class="s"> number of preferences to read from input file </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"--[max_set_size] </span><span class="se">\n</span><span class="s"> maximum size of a set </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">pass</span>

    <span class="n">output_file_stable_pairs</span> <span class="o">=</span> <span class="s">'pools.csv'</span>
    <span class="n">output_file_sets</span> <span class="o">=</span> <span class="s">'sets.csv'</span>
    
    <span class="c1"># Import and Encode the preferences data
</span>    <span class="n">preferences</span><span class="p">,</span><span class="n">names</span> <span class="o">=</span> <span class="n">import_preferences</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span> 
    <span class="n">preferences</span> <span class="o">=</span> <span class="n">encode_preferences</span><span class="p">(</span><span class="n">preferences</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Input file with {} preferences read and encoded successfully as </span><span class="se">\n</span><span class="s"> {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">no_of_preferences</span><span class="p">,</span> <span class="n">preferences</span><span class="p">))</span>

    <span class="n">null_position</span> <span class="o">=</span> <span class="n">return_null_position</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Instantiating Acceptor and Proposer objects with input preference data... </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">acceptors_table</span> <span class="o">=</span> <span class="n">preferences</span>
    <span class="c1">#acceptors_table = [[1,3,2,4],[3,4,1,2],[4,2,3,1],[3,2,1,4]]
</span>    <span class="n">proposers_table</span> <span class="o">=</span> <span class="n">acceptors_table</span>

    <span class="c1"># Instantiate the Acceptor and Proposer class objects
</span>    <span class="n">accepter_object</span> <span class="o">=</span> <span class="n">Acceptor</span><span class="p">(</span><span class="n">acceptors_table</span><span class="p">)</span>
    <span class="n">proposer_object</span> <span class="o">=</span> <span class="n">Proposer</span><span class="p">(</span><span class="n">proposers_table</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Instantiating Pool and Pools objects ready to hold engagements... </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="c1"># Instantiate the Pools Class object
</span>    <span class="n">pools_object</span> <span class="o">=</span> <span class="n">Pools</span><span class="p">()</span>

    <span class="c1"># Run the Algorithm
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Finding Stable Pairs with {} iterations of the algorithm... </span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
    <span class="n">stable_marriage</span><span class="p">(</span><span class="n">pools_object</span><span class="p">,</span><span class="n">proposer_object</span><span class="p">,</span><span class="n">proposers_table</span><span class="p">,</span><span class="n">accepter_object</span><span class="p">,</span><span class="n">acceptors_table</span><span class="p">,</span><span class="n">iteration</span><span class="p">,</span><span class="n">no_of_preferences</span><span class="p">,</span><span class="n">null_position</span><span class="p">,</span><span class="n">max_set_size</span><span class="p">,</span><span class="n">names</span><span class="p">)</span>

    <span class="c1"># Write the engagements to file
</span>    <span class="n">pairs</span> <span class="o">=</span> <span class="n">build_pairs</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">pools_object</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Writing pairs to file (1st iteration row 1 - 2, 2nd iteration 1 - 3 etc.)</span><span class="se">\n</span><span class="s"> {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pairs</span><span class="p">))</span>
    <span class="c1">#print("\n Writing pairs to file (1st iteration row 1 - 2, 2nd iteration 1 - 3 etc.)\n")
</span>    <span class="n">pairs</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file_stable_pairs</span><span class="p">)</span>

    <span class="c1"># Convert engagements to sets and write to file
</span>    <span class="n">groups</span> <span class="o">=</span> <span class="n">build_groups</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">pairs</span><span class="p">,</span><span class="n">pools_object</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Writing sets to file (a set is a column)</span><span class="se">\n</span><span class="s"> {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"length of groups"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
    <span class="n">groups</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_file_sets</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></figure>

<h1>Running the program</h1>

<p>The output data we get from the input data above is as follows. Note that in the final dataframe the sets are displayed as columns.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"> <span class="n">Input</span> <span class="nb">file</span> <span class="n">read</span> <span class="k">from</span> <span class="nb">file</span> 

<span class="p">[</span><span class="s">'Name'</span><span class="p">,</span> <span class="s">'Preference_1'</span><span class="p">,</span> <span class="s">'Preference_2'</span><span class="p">,</span> <span class="s">'Preference_3'</span><span class="p">,</span> <span class="s">'Preference_4'</span><span class="p">,</span> <span class="s">'Preference_5'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'Johnny'</span><span class="p">,</span> <span class="s">'Barry'</span><span class="p">,</span> <span class="s">'Charlie'</span><span class="p">,</span> <span class="s">'Gilly'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'Alphie'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'Barry'</span><span class="p">,</span> <span class="s">'Alphie'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'Charlie'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'Alphie'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'Danny'</span><span class="p">,</span> <span class="s">'Charlie'</span><span class="p">,</span> <span class="s">'Elle'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'Elle'</span><span class="p">,</span> <span class="s">'Freddie'</span><span class="p">,</span> <span class="s">'Danny'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'Freddie'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'Gilly'</span><span class="p">,</span> <span class="s">'Danny'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'Gilly'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'Johnny'</span><span class="p">,</span> <span class="s">'Freddie'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">]</span>
<span class="p">[</span><span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">]</span>

 <span class="n">Input</span> <span class="nb">file</span> <span class="k">with</span> <span class="mi">5</span> <span class="n">preferences</span> <span class="n">read</span> <span class="ow">and</span> <span class="n">encoded</span> <span class="n">successfully</span> <span class="k">as</span> 
 <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>

 <span class="n">Instantiating</span> <span class="n">Acceptor</span> <span class="ow">and</span> <span class="n">Proposer</span> <span class="n">objects</span> <span class="k">with</span> <span class="nb">input</span> <span class="n">preference</span> <span class="n">data</span><span class="p">...</span> 


 <span class="n">Instantiating</span> <span class="n">Pool</span> <span class="ow">and</span> <span class="n">Pools</span> <span class="n">objects</span> <span class="n">ready</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">engagements</span><span class="p">...</span> 


 <span class="n">Finding</span> <span class="n">Stable</span> <span class="n">Pairs</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">iterations</span> <span class="n">of</span> <span class="n">the</span> <span class="n">algorithm</span><span class="p">...</span> 


 <span class="n">Engagements</span> <span class="p">(</span><span class="nb">all</span> <span class="n">members</span><span class="p">)</span> <span class="n">found</span> <span class="n">at</span> <span class="n">iteration</span> <span class="mi">1</span> 
 <span class="p">[</span> <span class="mf">8.</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span>  <span class="mf">6.</span>  <span class="mf">5.</span> <span class="n">nan</span>  <span class="mf">1.</span> <span class="n">nan</span><span class="p">]</span>

 <span class="n">Engagements</span> <span class="p">(</span><span class="n">Orpans</span><span class="p">)</span> <span class="n">found</span> <span class="n">at</span> <span class="n">iteration</span> <span class="mi">1</span> 
 <span class="p">[</span><span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span>  <span class="mf">8.</span>  <span class="mf">7.</span> <span class="n">nan</span><span class="p">]</span>

 <span class="n">Engagements</span> <span class="p">(</span><span class="nb">all</span> <span class="n">members</span><span class="p">)</span> <span class="n">found</span> <span class="n">at</span> <span class="n">iteration</span> <span class="mi">2</span> 
 <span class="p">[</span><span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span><span class="p">]</span>

 <span class="n">Engagements</span> <span class="p">(</span><span class="n">Orpans</span><span class="p">)</span> <span class="n">found</span> <span class="n">at</span> <span class="n">iteration</span> <span class="mi">2</span> 
 <span class="p">[</span><span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span><span class="p">]</span>

 <span class="n">Writing</span> <span class="n">pairs</span> <span class="n">to</span> <span class="nb">file</span> <span class="p">(</span><span class="mi">1</span><span class="n">st</span> <span class="n">iteration</span> <span class="n">row</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">iteration</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">3</span> <span class="n">etc</span><span class="p">.)</span>
          <span class="mi">0</span>       <span class="mi">1</span>        <span class="mi">2</span>     <span class="mi">3</span>     <span class="mi">4</span>
<span class="mi">0</span>   <span class="n">Johnny</span>   <span class="n">Gilly</span>     <span class="bp">None</span>  <span class="bp">None</span>  <span class="bp">None</span>
<span class="mi">1</span>   <span class="n">Alphie</span>    <span class="bp">None</span>     <span class="bp">None</span>  <span class="bp">None</span>  <span class="bp">None</span>
<span class="mi">2</span>    <span class="n">Barry</span>    <span class="bp">None</span>     <span class="bp">None</span>  <span class="bp">None</span>  <span class="bp">None</span>
<span class="mi">3</span>  <span class="n">Charlie</span>    <span class="bp">None</span>     <span class="bp">None</span>  <span class="bp">None</span>  <span class="bp">None</span>
<span class="mi">4</span>    <span class="n">Danny</span>    <span class="n">Elle</span>     <span class="bp">None</span>  <span class="bp">None</span>  <span class="bp">None</span>
<span class="mi">5</span>     <span class="n">Elle</span>   <span class="n">Danny</span>     <span class="bp">None</span>  <span class="bp">None</span>  <span class="bp">None</span>
<span class="mi">6</span>  <span class="n">Freddie</span>    <span class="bp">None</span>    <span class="n">Gilly</span>  <span class="bp">None</span>  <span class="bp">None</span>
<span class="mi">7</span>    <span class="n">Gilly</span>  <span class="n">Johnny</span>  <span class="n">Freddie</span>  <span class="bp">None</span>  <span class="bp">None</span>
<span class="mi">8</span>     <span class="n">null</span>    <span class="bp">None</span>     <span class="bp">None</span>  <span class="bp">None</span>  <span class="bp">None</span>

 <span class="n">Writing</span> <span class="n">sets</span> <span class="n">to</span> <span class="nb">file</span> <span class="p">(</span><span class="n">a</span> <span class="nb">set</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">column</span><span class="p">)</span>
         <span class="mi">0</span>      <span class="mi">1</span>        <span class="mi">2</span>      <span class="mi">3</span>        <span class="mi">4</span>     <span class="mi">5</span>
<span class="mi">0</span>  <span class="n">Alphie</span>  <span class="n">Barry</span>  <span class="n">Charlie</span>  <span class="n">Danny</span>    <span class="n">Gilly</span>  <span class="bp">None</span>
<span class="mi">1</span>    <span class="bp">None</span>   <span class="bp">None</span>     <span class="bp">None</span>   <span class="n">Elle</span>   <span class="n">Johnny</span>  <span class="bp">None</span>
<span class="mi">2</span>    <span class="bp">None</span>   <span class="bp">None</span>     <span class="bp">None</span>   <span class="bp">None</span>  <span class="n">Freddie</span>  <span class="bp">None</span>
<span class="n">length</span> <span class="n">of</span> <span class="n">groups</span> <span class="mi">3</span></code></pre></figure>

<p>So the final output of sets is as follows and we can see that it has observed the very simply list of preferences in our input file:</p>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:black;}
.tg .tg-us36{vertical-align:top}
.tg .tg-xxzo{background-color:#c0c0c0;vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-xxzo">Set 1</th>
    <th class="tg-xxzo">Set 2</th>
    <th class="tg-xxzo">Set 3</th>
    <th class="tg-xxzo">Set 4</th>
    <th class="tg-xxzo">Set 5</th>
</tr>
  <tr>
    <th class="tg-us36">Alphie</th>
    <th class="tg-us36">Barry</th>
    <th class="tg-us36">Charlie</th>
    <th class="tg-us36">Danny</th>
    <th class="tg-us36">Gilly</th>

  </tr>
  <tr>
        <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36">Elle</th>
    <th class="tg-us36">Johnny</th>
  </tr>
  <tr>
            <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36"></th>
    <th class="tg-us36">Freddie</th>
  </tr>
</table>

<p>A full version of the code is available to download from my GitHub page <a href="https://github.com/jamesdhope/teaching-lecturing-resources/blob/master/stableGroupsX4.py">here.</a></p>

<p>For more information on my implementation of the Stable Marriage Algorithm DM @jamesdhope or email <a href="mailto:"></a>.</p>]]></content><author><name>James Hope</name></author><category term="edtech," /><category term="coding," /><category term="programming," /><category term="python," /><category term="computing," /><category term="computer-science" /><summary type="html"><![CDATA[In my previous post, I explained my implementation of the Stable Marriage Algorithm to find stable pairs. Taking this implementation one step further, I wanted to use the Stable Marriage Algorithm iteratively, to join stable pairs to other stable pairs to forms groups (or sets). This post explains my implementation of how I have used the Stable Marriage Algorithm to form groups of stable pairs.]]></summary></entry></feed>